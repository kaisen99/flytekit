
<!--
help_text: ''
key: summary_neptune.ai_tracking_5a072ff3-fbb1-46b3-a540-d0ace7b214d8
modules:
- flytekitplugins.neptune.tracking
questions_to_answer: []
type: summary

-->
Neptune.ai Tracking

Neptune.ai Tracking provides a seamless integration for logging machine learning experiments and metadata from Flyte tasks to Neptune.ai. This mechanism automates the lifecycle of a Neptune run, ensuring that experiments are properly initialized, enriched with Flyte-specific context, and terminated upon task completion.

## Usage

To enable Neptune.ai tracking for a Flyte task, apply the Neptune.ai tracking decorator to the task function. This decorator handles the initialization and termination of a Neptune run, making the `neptune.Run` object available within the task's execution context.

```python
import neptune
from flytekit import task, Secret
from flytekitplugins.neptune.tracking import neptune_init_run # Assuming this is the public decorator

@neptune_init_run(
    project="your-neptune-project/your-project-name",
    secret=Secret(group="neptune", key="api_token"),
    name="My Flyte Experiment",
    tags=["flyte", "example", "model-training"],
)
@task
def my_training_task(hyperparameters: dict, data_path: str) -> float:
    # Access the Neptune run object from the Flyte context
    from flytekit import current_context
    neptune_run = current_context().user_space_params.NEPTUNE_RUN

    # Log hyperparameters
    neptune_run["hyperparameters"] = hyperparameters

    # Simulate training
    accuracy = 0.92
    neptune_run["metrics/accuracy"] = accuracy

    # Log a file
    with open("model_summary.txt", "w") as f:
        f.write("Model trained successfully.")
    neptune_run["model_summary"].upload("model_summary.txt")

    return accuracy
```

## Configuration

The Neptune.ai tracking decorator accepts several parameters to configure the Neptune run:

*   **`project`** (str): The full name of your Neptune.ai project, typically in the format `workspace-name/project-name`. This parameter is required.
*   **`secret`** (Union[Secret, Callable]): Specifies how to retrieve the Neptune API token.
    *   If a `flytekit.Secret` object is provided, the tracking mechanism fetches the API token securely from Flyte's secret management system using the specified `group` and `key`. This is the recommended approach for production environments.
    *   If a `Callable` is provided, the function is invoked to retrieve the API token. This can be useful for custom token retrieval logic, though less secure than Flyte secrets.
*   **`host`** (str, optional): The URL of the Neptune.ai server. Defaults to `https://app.neptune.ai`.
*   **`**init_run_kwargs`** (dict, optional): Any additional keyword arguments are passed directly to the underlying `neptune.init_run` function. This allows for fine-grained control over the Neptune run's initialization, such as setting the run `name`, `tags`, `description`, or `mode`.

## Automatic Metadata Logging

Beyond the parameters explicitly passed, the Neptune.ai tracking mechanism automatically logs a comprehensive set of Flyte execution and task metadata to the Neptune run. This provides immediate context about where and how your experiment was executed within Flyte.

The following metadata is automatically captured under the `flyte/` namespace in Neptune:

*   **Execution-specific metadata**:
    *   `flyte/execution_id`: A unique identifier for the Flyte execution (derived from `HOSTNAME` environment variable or execution name).
    *   `flyte/project`: The Flyte project name.
    *   `flyte/domain`: The Flyte domain.
    *   `flyte/name`: The name of the Flyte execution.
    *   `flyte/raw_output_prefix`: The S3/blob storage prefix for raw outputs.
    *   `flyte/output_metadata_prefix`: The S3/blob storage prefix for output metadata.
    *   `flyte/working_directory`: The working directory for the task.
    *   `flyte/execution_url`: The URL to the Flyte console for the current execution, if the `FLYTE_EXECUTION_URL` environment variable is set.
*   **Task-specific metadata**:
    *   `flyte/task/name`: The name of the Flyte task.
    *   `flyte/task/project`: The Flyte project of the task.
    *   `flyte/task/domain`: The Flyte domain of the task.
    *   `flyte/task/version`: The version of the Flyte task.

This automatic logging reduces boilerplate code and ensures consistency in experiment tracking across your Flyte workflows.

## Accessing the Neptune Run Object

Within a task decorated with the Neptune.ai tracking mechanism, the active `neptune.Run` object is injected into the Flyte context's user space parameters. This allows direct interaction with the Neptune client to log additional metrics, parameters, artifacts, or other custom data.

Retrieve the `neptune.Run` object using `current_context().user_space_params.NEPTUNE_RUN`.

```python
from flytekit import current_context

def log_custom_metrics(metric_value: float):
    neptune_run = current_context().user_space_params.NEPTUNE_RUN
    neptune_run["custom_metrics/my_metric"] = metric_value
```

## Local Execution Behavior

When a Flyte task decorated with the Neptune.ai tracking mechanism executes in a local development environment (e.g., using `pyflyte run`), the behavior adapts to simplify local testing:

*   The Neptune API token is not required.
*   The automatic logging of Flyte-specific metadata is skipped, as this metadata is primarily relevant for remote Flyte executions.

The Neptune run still initializes and terminates, allowing developers to test their logging logic without needing a full Flyte deployment or Neptune API token configured.

## Considerations and Best Practices

*   **Secrets Management**: Always use `flytekit.Secret` for managing your Neptune API token in production environments. This ensures that sensitive credentials are not hardcoded or exposed in your codebase.
*   **Run Lifecycle**: The tracking mechanism automatically handles `neptune.init_run()` at the start of the task and `run.stop()` at the end. Avoid calling these methods manually within the decorated task to prevent conflicts or unexpected behavior.
*   **Performance Overhead**: The overhead introduced by the Neptune.ai tracking mechanism is minimal, primarily involving network calls for initialization and logging. For tasks with very short execution times, consider batching logs or evaluating if tracking is necessary for every single execution.
*   **Error Handling**: If the Neptune.ai service is unreachable or credentials are invalid during remote execution, the `neptune.init_run` call may raise an exception, causing the Flyte task to fail. Ensure proper network connectivity and secret configuration.
<!--
key: summary_neptune.ai_tracking_5a072ff3-fbb1-46b3-a540-d0ace7b214d8
type: summary_end

-->
<!--
code_unit: flytekitplugins.neptune.examples.neptune_tracking_example
code_unit_type: class
help_text: ''
key: example_6e37dcbe-483e-4a06-a82e-a3b78a85e45a
type: example

-->