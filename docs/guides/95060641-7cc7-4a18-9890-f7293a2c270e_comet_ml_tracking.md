
<!--
help_text: ''
key: summary_comet_ml_tracking_0d1a8bb7-815a-4be5-86c4-cd8e0e52c475
modules:
- flytekitplugins.comet_ml.tracking
questions_to_answer: []
type: summary

-->
Comet ML Tracking provides a seamless way to integrate Comet ML experiment tracking into your machine learning workflows. This integration automatically handles the authentication and initialization of Comet ML experiments, allowing you to focus on logging metrics, parameters, and artifacts within your tasks.

## Integrating Comet ML

To enable Comet ML tracking for a task, apply the Comet ML login decorator to your task definition. This decorator ensures that a Comet ML experiment is properly initialized before your task's code executes, linking your task's run to a specific Comet ML project and workspace.

The decorator requires the following parameters:

*   `project_name` (str): The name of the Comet ML project where your experiment data will be sent. This is a required field.
*   `workspace` (str): The name of the Comet ML workspace that owns the specified project. This is also a required field.
*   `secret` (Secret or Callable): Your Comet ML API key. This can be provided in two ways:
    *   As a `Secret` object, referencing a secret stored within your execution environment. The secret must contain your `COMET_API_KEY`.
    *   As a callable (a function or lambda) that takes no arguments and returns your API key as a string. This is useful for dynamic retrieval or when the API key is not managed as a Flyte secret.

Optional parameters include:

*   `experiment_key` (str, optional): A specific key to identify your experiment. If not provided, a key is automatically generated based on the execution context.
*   `host` (str): The URL to your Comet ML service. Defaults to `https://www.comet.com`.
*   `**login_kwargs` (dict): Any additional keyword arguments are passed directly to the underlying `comet_ml.login` or `comet_ml.init` function.

### Example Usage

```python
import os
from flytekit import task, workflow, Secret
from flytekitplugins.comet_ml.tracking import comet_ml_login # Assuming this is the exposed decorator

# Define a secret for your Comet ML API key
# Ensure 'comet-ml-api-key' is configured in your Flyte project secrets
comet_ml_secret = Secret(group="comet-ml", key="comet-ml-api-key")

@comet_ml_login(
    project_name="my-ml-project",
    workspace="my-workspace",
    secret=comet_ml_secret,
    # Optional: provide a custom experiment key
    # experiment_key="my-custom-experiment-run-123",
    # Optional: pass additional login arguments
    # log_code=False,
)
@task
def train_model_task(epochs: int) -> float:
    # Import comet_ml inside the task to ensure it's available after login
    import comet_ml

    # Get the current experiment instance
    experiment = comet_ml.get_experiment()

    if experiment:
        experiment.log_parameter("epochs", epochs)
        experiment.log_metric("initial_loss", 1.0)

        # Simulate training
        loss = 1.0
        for i in range(epochs):
            loss *= 0.9
            experiment.log_metric("loss", loss, step=i)
            print(f"Epoch {i+1}, Loss: {loss:.4f}")

        experiment.log_metric("final_loss", loss)
        experiment.log_artifact("model_weights.pth", "path/to/model.pth") # Example artifact logging
        print(f"Comet ML experiment URL: {experiment.url}")
    else:
        print("Comet ML experiment not initialized.")

    return loss

@workflow
def training_workflow(epochs: int = 5):
    train_model_task(epochs=epochs)

```

## Authentication and API Key Management

The Comet ML integration prioritizes secure handling of your API key.

*   **Using `Secret` objects:** This is the recommended approach for remote executions. Your API key is retrieved securely from the execution environment's secret store, preventing it from being hardcoded or exposed in logs.
*   **Using a Callable:** For scenarios where the API key is not managed as a Flyte secret, you can provide a Python callable. This callable is executed at runtime to obtain the API key. Ensure this callable does not expose sensitive information.

For local executions, the `api_key` parameter is not explicitly passed to `comet_ml.login` or `comet_ml.init`. Comet ML's SDK typically looks for the `COMET_API_KEY` environment variable or a configuration file (`~/.comet.config`).

## Experiment Key Generation

The `experiment_key` uniquely identifies an experiment in Comet ML.

*   **Explicitly Provided:** If you provide an `experiment_key` to the decorator, that specific key is used for your experiment. This is useful for resuming specific experiments or for highly controlled tracking.
*   **Automatic Generation (Remote Execution):** When `experiment_key` is not provided for a remote execution, a unique key is automatically generated. This key is derived from the execution's hostname (typically `{.executionName}-{.nodeID}-{.taskRetryAttempt}`) or the execution name as a fallback, combined with the project and workspace names. This ensures each task execution gets a distinct experiment, making it easy to trace back to the specific Flyte run.
*   **Automatic Generation (Local Execution):** For local executions, if `experiment_key` is not provided, Comet ML's SDK generates its own key.

## Local vs. Remote Execution Behavior

The Comet ML integration adapts its behavior based on the execution environment:

*   **Local Execution:**
    *   The `api_key` is not explicitly passed to Comet ML. It expects the API key to be available via environment variables or configuration files.
    *   If `experiment_key` is `None`, Comet ML generates a new key.
*   **Remote Execution:**
    *   The `api_key` is retrieved from the specified `Secret` or callable and passed to Comet ML.
    *   If `experiment_key` is `None`, a unique key is generated based on the Flyte execution context to ensure traceability.

The integration uses `comet_ml.login` if available (for newer Comet ML SDK versions) or falls back to `comet_ml.init` for compatibility.

## Monitoring and UI Integration

The Comet ML integration enhances the Flyte UI by providing direct links to your Comet ML experiments. After a task decorated with the Comet ML login decorator completes, you can find a link in the Flyte UI that navigates directly to the corresponding experiment in Comet ML. This link is constructed using the `project_name`, `workspace`, `host`, and either the `experiment_key` or a generated suffix.

## Best Practices and Considerations

*   **API Key Security:** Always use Flyte's `Secret` management for your Comet ML API key in production environments. Avoid hardcoding keys.
*   **Granularity of Tracking:** The Comet ML login decorator initializes the experiment. To log metrics, parameters, code, and artifacts, you must use the `comet_ml` SDK directly within your task's code (e.g., `comet_ml.log_metric(...)`).
*   **Dependencies:** Ensure the `comet_ml` library is included in your task's dependencies (e.g., in your `requirements.txt` or `Dockerfile`).
*   **Experiment Key Strategy:** Decide whether to explicitly provide `experiment_key` for fine-grained control or rely on automatic generation for simpler, execution-based tracking. Automatic generation is generally preferred for iterative development and debugging, as it provides a unique experiment for each run.
*   **Performance:** The overhead of initializing Comet ML is minimal and typically does not impact the performance of your core machine learning computations.
<!--
key: summary_comet_ml_tracking_0d1a8bb7-815a-4be5-86c4-cd8e0e52c475
type: summary_end

-->
<!--
code_unit: flytekitplugins.comet_ml.examples.comet_ml_tracking_example
code_unit_type: class
help_text: ''
key: example_581694d0-c3e6-4c69-bf02-25943fa74a96
type: example

-->